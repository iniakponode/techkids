{% extends "layout/base.html" %}

{% block title %}TechKids | Registration{% endblock %}

{% block extra_head %}
<script src="/static/js/pages/registration.js" defer></script>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4">Course Registration</h1>

            <div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header alert-success">
                            <h1 class="modal-title fs-5" id="paymentSuccessModalLabel">Payment Successful</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="paymentSuccessBody">
                            </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="paymentErrorModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="paymentErrorModalLabel">Payment Error</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="paymentErrorBody">
                            </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    {% include "partials/registration_form.html" %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if request.query_params.get("payment_success") == "true" %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const paymentSuccess = urlParams.get("payment_success") === "true";
    const orderId = urlParams.get("order_id");
    const token = urlParams.get("token");

    if (paymentSuccess && orderId && token) {
        fetch(`/api/paystack/success_details/${token}`)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error("Invalid or expired payment success token.");
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }
                return response.json();
            })
            .then(data => {
                const modalBody = document.getElementById("paymentSuccessBody");
                if (modalBody) {
                    modalBody.innerHTML = `
                        <p>Your payment for Order #${data.order_id} was processed successfully!</p>
                        <p>Amount Paid: ₦${data.amount}</p>
                        <p>Payment Date: ${data.payment_date}</p>
                        <p>Courses Registered:</p>
                        <ul>
                            ${data.courses.map(course => `
                                <li>
                                    <strong>${course.title}</strong> - ₦${course.price}
                                </li>
                            `).join('')}
                        </ul>
                        <p>Thank you for your purchase! You can register for more courses or continue exploring our site.</p>
                    `;
                }
                var successModal = new bootstrap.Modal(document.getElementById("paymentSuccessModal"));
                successModal.show();
            })
            .catch(error => {
                console.error("Error fetching payment success details:", error);
                alert("There was an issue displaying your payment confirmation. Please contact support with your Order ID.");
            });
    } else if (paymentSuccess && orderId) {
        // Handle case where token might be missing (e.g., error during token generation)
        console.warn("Payment success indicated but token is missing.");
        alert("Payment was successful, but we couldn't retrieve the details. Please contact support with your Order ID.");
    }
});
</script>
{% elif request.query_params.get("payment_success") == "false" %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get("order_id");
    const modalBody = document.getElementById("paymentErrorBody");
    if (modalBody) {
        modalBody.innerHTML = `<p>Your payment for Order #${orderId} was not successful. Please try again or contact support.</p>`;
    }
    var errorModal = new bootstrap.Modal(document.getElementById("paymentErrorModal"));
    errorModal.show();
});
</script>
{% elif request.query_params.get("payment_error") %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const errorMsg = new URLSearchParams(window.location.search).get("payment_error") || "An unknown error occurred during payment.";
    const modalBody = document.getElementById("paymentErrorBody");
    if (modalBody) {
        modalBody.innerHTML = `<p>${errorMsg}</p>`;
    }
    var errorModal = new bootstrap.Modal(document.getElementById("paymentErrorModal"));
    errorModal.show();
});
</script>
{% endif %}
{% endblock %}